<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Dividend Calculator</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; }
    label, select, input { display: block; width: 100%; margin: 10px 0; padding: 8px; font-size: 1em; }
    button { padding: 10px 20px; font-size: 1em; margin-top: 15px; }
    .section { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .output { background: #f2f2f2; padding: 15px; margin-top: 20px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>ระบบคำนวณเงินปันผลอัตโนมัติ</h1>
  <div class="section">
    <label>ประเภทหุ้น:
      <select id="market" onchange="fetchSymbols()">
        <option value="us">หุ้นสหรัฐ</option>
        <option value="th">หุ้นไทย</option>
      </select>
    </label>

    <label>ชื่อหุ้น:
      <input type="text" id="stockSymbol" placeholder="พิมพ์ชื่อหรือสัญลักษณ์หุ้น" list="stockList">
      <datalist id="stockList"></datalist>
    </label>

    <label>คุณมีหุ้นอยู่แล้วหรือไม่:
      <select id="haveShares" onchange="toggleMode()">
        <option value="no">ไม่มี</option>
        <option value="yes">มี</option>
      </select>
    </label>

    <div id="investmentBlock">
      <label>เงินลงทุน (บาท): <input type="text" id="investment" oninput="formatNumberInput(this)"></label>
    </div>

    <div id="shareBlock" style="display:none">
      <label>จำนวนหุ้นที่มี: <input type="number" id="shares" step="0.0001"></label>
    </div>

    <button onclick="calculateDividend()">คำนวณเงินปันผล</button>
    <div class="output" id="result"></div>
  </div>

  <script>
    function formatNumberInput(input) {
      const value = input.value.replace(/,/g, '');
      if (!isNaN(value) && value !== '') {
        input.value = parseFloat(value).toLocaleString('en-US');
      }
    }

    function parseNumber(str) {
      return parseFloat(str.replace(/,/g, '')) || 0;
    }

    function toggleMode() {
      const mode = document.getElementById("haveShares").value;
      document.getElementById("investmentBlock").style.display = mode === "no" ? "block" : "none";
      document.getElementById("shareBlock").style.display = mode === "yes" ? "block" : "none";
    }

    function fetchSymbols() {
      const market = document.getElementById("market").value;
      const list = document.getElementById("stockList");
      list.innerHTML = "";
      const mockStocks = market === 'us'
        ? ['AAPL', 'MSFT', 'TSLA', 'JEPQ']
        : ['PTT', 'CPALL', 'ADVANC', 'BBL'];
      mockStocks.forEach(s => {
        const option = document.createElement("option");
        option.value = s;
        list.appendChild(option);
      });
    }

    function fetchExchangeRate(callback) {
      fetch('https://api.exchangerate.host/latest?base=USD&symbols=THB')
        .then(res => res.json())
        .then(data => callback(data.rates.THB));
    }

    function fetchStockData(symbol, market, callback) {
  if (market === 'us') {
    // Fetch from Yahoo Finance for US stocks
    const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail`;
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const detail = data.quoteSummary?.result?.[0]?.summaryDetail;
        if (!detail) return callback({ price: 0, dividend: 0 });
        const price = detail.previousClose?.raw || 0;
        const dividend = detail.dividendRate?.raw || 0;
        callback({ price, dividend });
      })
      .catch(() => callback({ price: 0, dividend: 0 }));
  } else {
    // ยังใช้ mock สำหรับหุ้นไทย (สามารถเชื่อม SET API ได้ในอนาคต)
    const mockData = {
      'PTT': { price: 34.25, dividend: 1.75 },
      'ADVANC': { price: 220.00, dividend: 6.50 },
      'CPALL': { price: 61.00, dividend: 2.40 },
      'BBL': { price: 127.00, dividend: 4.00 }
    };
    callback(mockData[symbol] || { price: 100, dividend: 1 });
  }
}
    }

    function calculateDividend() {
      const market = document.getElementById('market').value;
      const symbol = document.getElementById('stockSymbol').value.trim();
      const haveShares = document.getElementById('haveShares').value;

      if (!symbol) return alert("กรุณาใส่ชื่อหุ้น");

      fetchExchangeRate(rate => {
        fetchStockData(symbol, market, stock => {
          let shares = 0;
          let usedTHB = 0;

          if (haveShares === 'yes') {
            shares = parseFloat(document.getElementById('shares').value);
            usedTHB = shares * stock.price * (market === 'us' ? rate : 1);
          } else {
            const investment = parseNumber(document.getElementById('investment').value);
            shares = investment / (stock.price * (market === 'us' ? rate : 1));
            usedTHB = investment;
          }

          const dividendYear = shares * stock.dividend;
          const afterTax = dividendYear * (market === 'us' ? 0.85 : 0.9);
          const dividendYield = (stock.dividend / stock.price) * 100;

          document.getElementById('result').innerHTML = `
            หุ้น: ${symbol} (${market === 'us' ? 'สหรัฐ' : 'ไทย'})<br>
            ราคาหุ้น: ${stock.price.toFixed(2)} ${market === 'us' ? 'USD' : 'บาท'}<br>
            เงินลงทุนทั้งหมด: ${usedTHB.toLocaleString(undefined, {minimumFractionDigits: 2})} บาท<br>
            จำนวนหุ้น: ${shares.toFixed(4)} หุ้น<br>
            อัตราเงินปันผล (Dividend Yield): ${dividendYield.toFixed(2)}%<br><br>
            ▶ เงินปันผลต่อปี (ก่อนหักภาษี): ${dividendYear.toFixed(2)} ${market === 'us' ? 'USD' : 'บาท'}<br>
            ▶ เงินปันผลหลังหักภาษี: ${afterTax.toFixed(2)} ${market === 'us' ? 'USD' : 'บาท'}
          `;
        });
      });
    }

    fetchSymbols();
  </script>
</body>
</html>
